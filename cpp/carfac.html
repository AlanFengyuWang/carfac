<html>
<head>
<title>CARFAC</title>
<script src="carfac.js"></script>
<script>
function InitWebAudio() {
  var context = new webkitAudioContext();
  console.log("sampleRate = " + context.sampleRate);
  console.assert(context.sampleRate == 44100);

  var audio = document.getElementById('audio_source');
  var mediaSourceNode = context.createMediaElementSource(audio);

  // Use as a (not very good) anti-aliasing filter.
  var antiAliasFilterNode = context.createBiquadFilter();
  antiAliasFilterNode.frequency = 8000;  // Hertz.
  antiAliasFilterNode.Q = 0;

  var bufferSize = 2048;
  saiNode = context.createScriptProcessor(bufferSize, 1,  // numInputChannels
                                          1);  // numOutputChannels

  // Configure the canvas element that the SAIPlotter will render to.
  Module.canvas = document.getElementById('sai_canvas');

  // TODO(ronw): Add some controls (and hooks in the C++ class) to
  // allow users to configure the various CARFAC and SAI params.

  // The input will be downsampled by a factor of two before being
  // passed into the SAIPlotter.
  var saiPlotter = new Module.SAIPlotter(context.sampleRate / 2,
                                         bufferSize / 2);
  var sampleBuffer = Module._malloc(4 * bufferSize / 2);
  saiNode.onaudioprocess = CreateAudioProcessCallback(saiPlotter, sampleBuffer);

  mediaSourceNode.connect(antiAliasFilterNode);
  antiAliasFilterNode.connect(saiNode);
  // Hook up the sound output.
  saiNode.connect(context.destination);
}

function CreateAudioProcessCallback(saiPlotter, sampleBuffer) {
  return function (e) {
    var buffer = e.inputBuffer.getChannelData(0);

    // Copy the audio samples to the output so it can be sent to the sound
    // output.
    e.outputBuffer.getChannelData(0).set(buffer);

    var energy = 0;
    for (var i = 0; i < buffer.length; i += 2) {
      energy += buffer[i] * buffer[i];
      // Decimate by a factor of two before calling CARFAC.
      HEAPF32[(sampleBuffer >> 2) + i / 2] = buffer[i];
    }
    console.log(e.timeStamp + ": energy = " + energy);

    var sampleBufferLength = buffer.length / 2;
    saiPlotter.ComputeAndPlotSAI(sampleBuffer, sampleBufferLength);
  };
}

</script>
</head>
<body onload="InitWebAudio();">
  <canvas id="sai_canvas"></canvas>
  <br>
  <audio src="../test_data/long_test.wav"
         controls="controls"
         id="audio_source"/>
</body>
</html>
