<html>
<head>
<title>CARFAC</title>
<script src="carfac.js"></script>
<script>
function InitWebAudio() {
  var context = new webkitAudioContext();
  audio = document.getElementById('audio_source');
  var mediaSourceNode = context.createMediaElementSource(audio);

  var sampleRate = 44100;
  var bufferSize = 512;
  jsNode = context.createScriptProcessor(bufferSize, 1,  // numInputChannels
                                        1);  // numOutputChannels

  // Configure the canvas element that the SAIPlotter will render to.
  Module.canvas = document.getElementById('sai_canvas');

  // TODO(ronw): Add some controls to allow users to configure the
  // various CARFAC and SAI params.
  var saiPlotter = new Module.SAIPlotter(sampleRate, bufferSize);
  var sampleBuffer = Module._malloc(4 * bufferSize);
  jsNode.onaudioprocess = CreateAudioProcessCallback(saiPlotter, sampleBuffer);

  mediaSourceNode.connect(jsNode);
  // Hook up the sound output.
  jsNode.connect(context.destination);
}

function CreateAudioProcessCallback(saiPlotter, sampleBuffer) {
  return function (e) {
    var buffer = e.inputBuffer.getChannelData(0);

    var energy = 0;
    for (var i = 0; i < buffer.length; i++) {
      energy += buffer[i] * buffer[i];
      HEAPF32[(sampleBuffer >> 2) + i] = buffer[i];
    }
    console.log(e.timeStamp + ": energy = " + energy);

    saiPlotter.ComputeAndPlotSAI(sampleBuffer, buffer.length);

    // Copy the audio samples to the output so it can be sent to the sound output.
    e.outputBuffer.getChannelData(0).set(e.inputBuffer.getChannelData(0));
  };
}

</script>
</head>
<body onload="InitWebAudio();">
  <canvas id="sai_canvas"></canvas>
  <br>
  <audio src="../test_data/long_test.wav"
         controls="controls"
         id="audio_source"/>
</body>
</html>
